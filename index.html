<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PintScore ‚Äî Guinness Rating</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #070707;
    --panel: #0f0f10;
    --muted: #9aa0a6;
    --accent: #d4af37; /* gold */
    --card-border: rgba(255,255,255,0.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter, system-ui, Arial, sans-serif;
    background:linear-gradient(180deg,var(--bg),#050505 200px);
    color:#fff;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    display:flex;
    flex-direction:column;
    min-height:100vh;
  }

  /* App Shell */
  .app{
    flex:1 1 auto;
    display:flex;
    flex-direction:column;
    padding-bottom:72px; /* space for nav */
  }
  header{
    padding:14px 16px;
    display:flex;
    align-items:center;
    gap:12px;
    border-bottom:1px solid rgba(255,255,255,0.03);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    position:sticky;
    top:0;
    z-index:40;
  }
  .brand{
    display:flex;align-items:center;gap:10px;
  }
  .brand h1{font-size:18px;margin:0;font-weight:600}
  .brand p{margin:0;font-size:12px;color:var(--muted)}

  main{flex:1; padding:12px 16px; overflow:auto}

  /* Pages */
  .page{display:none}
  .page.active{display:block}

  /* Card */
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid var(--card-border);
    padding:12px;
    border-radius:12px;
    margin-bottom:12px;
  }

  /* Inputs */
  .input{
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    background:#0a0a0a;
    color:#fff;
    border:1px solid rgba(255,255,255,0.03);
    margin-top:8px;
    outline:none;
  }
  .row{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:13px}

  /* Pint icons */
  .pint-row{display:flex;gap:8px;margin-top:8px}
  .pint-btn{
    width:36px;height:46px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;
    background:transparent;border: none;padding:0;cursor:pointer;
    transition:transform .08s ease;
  }
  .pint-btn:active{transform:scale(.95)}
  .pint-svg{width:26px;height:36px;filter: drop-shadow(0 1px 0 rgba(0,0,0,0.6))}
  .pint-empty{opacity:0.35}
  .pint-on{filter: drop-shadow(0 4px 6px rgba(212,175,55,0.14));}

  /* overall 10-pint */
  .overall-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
  .overall-pint{width:18px;height:26px;opacity:0.28}
  .overall-on{opacity:1; filter: drop-shadow(0 4px 8px rgba(212,175,55,0.18))}

  /* Buttons */
  .btn{
    display:inline-block;padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:700;
    cursor:pointer;margin-top:10px;
  }
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

  /* Lists */
  .list-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px;background:rgba(255,255,255,0.01)}
  .thumb{width:60px;height:60px;border-radius:8px;background:#050505;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .item-body{flex:1}
  .small-muted{color:var(--muted);font-size:13px}

  /* bottom nav */
  .bottom-nav{
    position:fixed;left:0;right:0;bottom:0;height:64px;background:#070707;border-top:1px solid rgba(255,255,255,0.03);
    display:flex;justify-content:space-around;align-items:center;padding:6px 8px;z-index:60;
    backdrop-filter: blur(4px);
  }
  .nav-btn{
    display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);
    background:transparent;border:none;padding:6px;border-radius:10px;cursor:pointer;font-size:12px;width:64px;
  }
  .nav-btn.active{color:var(--accent)}
  .nav-ico{font-size:20px}

  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:200}
  .modal{width:94%;max-width:520px;background:linear-gradient(180deg,#0b0b0b,#090909);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .modal h3{margin:0 0 8px 0}

  /* responsiveness */
  @media(min-width:900px){
    main{max-width:880px;margin:0 auto}
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <!-- small pint svg logo -->
        <svg width="36" height="36" viewBox="0 0 64 64" aria-hidden>
          <defs><linearGradient id="g1" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#fff"/><stop offset="1" stop-color="#d4af37"/></linearGradient></defs>
          <rect width="64" height="64" rx="10" fill="#0b0b0b"/>
          <g transform="translate(14,8) scale(.9)">
            <path d="M12 1c-3 0-5 3-5 6 0 5 4 9 7 9s7-4 7-9c0-3-2-6-5-6z" fill="#0f0f0f" stroke="#d4af37" stroke-width="1"/>
            <ellipse cx="12" cy="9" rx="6" ry="3" fill="#f3e6cf"/>
          </g>
        </svg>
        <div>
          <h1>PintScore</h1>
          <p class="muted">Rate your Guinness ‚Äî keep it simple</p>
        </div>
      </div>
    </header>

    <main>

      <!-- PAGE: Map (placeholder/list of saved pints) -->
      <section id="page-map" class="page active">
        <div class="card">
          <h2>Saved Pints</h2>
          <p class="muted small">All pints you saved locally on this device.</p>
          <div id="saved-pints-list" style="margin-top:10px"></div>
          <div class="muted small" style="margin-top:8px">Tip: This is stored only on this device (Local Storage).</div>
        </div>
      </section>

      <!-- PAGE: Pub Crawl -->
      <section id="page-crawl" class="page">
        <div class="card">
          <h2>Create Pub Crawl</h2>
          <input id="crawl-name" class="input" placeholder="Crawl name (e.g. Friday Crawl)" />
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <input class="input" id="participant-1" placeholder="Participant 1 (optional)"/>
            <input class="input" id="participant-2" placeholder="Participant 2 (optional)"/>
            <input class="input" id="participant-3" placeholder="Participant 3 (optional)"/>
            <input class="input" id="participant-4" placeholder="Participant 4 (optional)"/>
            <input class="input" id="participant-5" placeholder="Participant 5 (optional)"/>
          </div>

          <div style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="muted small">Pubs in this crawl</div>
              <div>
                <button class="btn" onclick="openCrawlAddPub()">+ Add Pub</button>
              </div>
            </div>
            <div id="crawl-pub-list" style="margin-top:10px"></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" onclick="saveCrawl()">Save Crawl</button>
            <button class="btn ghost" onclick="clearCrawlForm()">Clear</button>
          </div>
        </div>

        <div class="card">
          <h3>Saved Crawls</h3>
          <div id="saved-crawls-list" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- PAGE: New Pint -->
      <section id="page-new" class="page">
        <div class="card">
          <h2>New Pint</h2>
          <input id="input-pub-name" class="input" placeholder="Pub name" />
          <label class="muted small" style="margin-top:6px">Upload photo (optional)</label>
          <input id="input-photo" type="file" accept="image/*" class="input" style="padding:8px" />
          <div id="photo-preview" style="margin-top:10px;display:none">
            <div style="width:100%;border-radius:10px;overflow:hidden;background:#050505" class="thumb"><img id="photo-preview-img" src="" alt="preview" /></div>
          </div>
          <div style="margin-top:10px" id="rating-categories"></div>

          <div style="margin-top:10px">
            <div class="muted small">Overall (out of 10)</div>
            <div id="overall-10" class="overall-row"></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" onclick="saveNewPint()">Save Pint</button>
            <button class="btn ghost" onclick="resetNewPintForm()">Reset</button>
          </div>
        </div>
      </section>

      <!-- PAGE: Profile -->
      <section id="page-profile" class="page">
        <div class="card">
          <h2>Profile</h2>
          <p class="muted small">Simple local profile (stored in Local Storage)</p>
          <input id="profile-name" class="input" placeholder="Your name (optional)" />
          <input id="profile-fave" class="input" placeholder="Favorite pub / drink (optional)" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="saveProfile()">Save Profile</button>
            <button class="btn ghost" onclick="clearProfile()">Clear</button>
          </div>
        </div>

        <div class="card">
          <h3>Your Summary</h3>
          <div id="profile-summary" style="margin-top:10px"></div>
        </div>
      </section>

    </main>

    <!-- bottom nav -->
    <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
      <button class="nav-btn active" id="nav-map" onclick="showPage('page-map', this)">
        <div class="nav-ico">üó∫Ô∏è</div><div style="font-size:11px">Map</div>
      </button>
      <button class="nav-btn" id="nav-crawl" onclick="showPage('page-crawl', this)">
        <div class="nav-ico">üë•</div><div style="font-size:11px">Crawl</div>
      </button>
      <button class="nav-btn" id="nav-new" onclick="showPage('page-new', this)">
        <div class="nav-ico">‚ûï</div><div style="font-size:11px">New</div>
      </button>
      <button class="nav-btn" id="nav-profile-btn" onclick="showPage('page-profile', this)">
        <div class="nav-ico">üßë</div><div style="font-size:11px">Profile</div>
      </button>
    </nav>
  </div>

  <!-- modal for rating (used for Crawl "add pub") -->
  <div id="modal-root" style="display:none"></div>

<script>
/* -------------------------
   Utilities & Data Storage
   ------------------------- */
const STORE = {
  PINTS: 'pintscore_pints_v1',
  CRAWLS: 'pintscore_crawls_v1',
  PROFILE: 'pintscore_profile_v1'
};
function loadPints(){ return JSON.parse(localStorage.getItem(STORE.PINTS) || '[]'); }
function savePints(arr){ localStorage.setItem(STORE.PINTS, JSON.stringify(arr)); }
function loadCrawls(){ return JSON.parse(localStorage.getItem(STORE.CRAWLS) || '[]'); }
function saveCrawls(arr){ localStorage.setItem(STORE.CRAWLS, JSON.stringify(arr)); }
function loadProfile(){ return JSON.parse(localStorage.getItem(STORE.PROFILE) || '{}'); }
function saveProfileObj(obj){ localStorage.setItem(STORE.PROFILE, JSON.stringify(obj)); }

/* -------------------------
   SVG icon: Guinness pint
   - two states: filled (gold/cream) and empty (dark)
   ------------------------- */
function pintSVG(fillColor='#d4af37', creamColor='#f3e6cf'){
  // returns an SVG string (small pint glass) using fillColor for body and creamColor for head
  return `
  <svg class="pint-svg" viewBox="0 0 64 96" xmlns="http://www.w3.org/2000/svg" aria-hidden>
    <g transform="translate(0,0)">
      <path d="M18 6c-3 0-5 2.7-5 6.4 0 5.8 4.1 16.8 5.9 22.2 2.2 6.1 3.2 11.8 3.2 19.4v16.5c0 5.4 2.8 8.6 6.8 8.6h0c4 0 6.8-3.2 6.8-8.6V54c0-7.6 1-13.3 3.2-19.4C44.9 28.9 49 18 49 12.2 49 8.5 47 6 44 6H18z" fill="${fillColor}" stroke="#000" stroke-opacity="0.15"/>
      <ellipse cx="32" cy="18" rx="14" ry="8" fill="${creamColor}" />
    </g>
  </svg>`;
}
function pintSVGEmpty(){
  return pintSVG('#222','#bfb6a0'); // muted glass + light cream
}

/* -------------------------
   Rating categories setup
   ------------------------- */
const CATEGORIES = ['Creaminess','Head','Taste','Temperature','Atmosphere'];
const MAX_PER_CAT = 5;
let currentRatings = {}; // for New Pint
CATEGORIES.forEach(c => currentRatings[c]=0);

const ratingContainer = document.getElementById('rating-categories');
const overall10 = document.getElementById('overall-10');

function buildRatingUI(targetRatings, onChangeCallback){
  // targetRatings is object to mutate (e.g. currentRatings or a temp for modal)
  // onChangeCallback will be called when values change
  ratingContainer.innerHTML = ''; // used for New Pint; for modal we create separately
  CATEGORIES.forEach(cat=>{
    const wrapper = document.createElement('div');
    wrapper.style.marginTop = '8px';
    const label = document.createElement('div'); label.innerText = cat; label.className='small-muted';
    wrapper.appendChild(label);

    const row = document.createElement('div'); row.className='pint-row';
    // create 5 buttons
    for(let i=1;i<=MAX_PER_CAT;i++){
      const btn = document.createElement('button');
      btn.className='pint-btn';
      btn.innerHTML = pintSVGEmpty();
      btn.dataset.cat = cat;
      btn.dataset.value = i;
      btn.addEventListener('click', ()=> {
        targetRatings[cat] = i;
        refreshRatingUI(targetRatings);
        onChangeCallback && onChangeCallback(targetRatings);
      });
      row.appendChild(btn);
    }
    wrapper.appendChild(row);
    ratingContainer.appendChild(wrapper);
  });
  refreshRatingUI(targetRatings);
}

function refreshRatingUI(targetRatings){
  // update New Pint UI
  // categories area
  const rows = ratingContainer.querySelectorAll('.pint-row');
  rows.forEach((row, idx) => {
    const cat = CATEGORIES[idx];
    const val = targetRatings[cat] || 0;
    const buttons = row.querySelectorAll('button .pint-svg');
    for(let i=0;i<buttons.length;i++){
      const btnWrapper = row.querySelectorAll('.pint-btn')[i];
      // replace inner svg with filled or empty
      if(i < val){
        btnWrapper.innerHTML = pintSVG(); // filled
        btnWrapper.firstElementChild.classList.add('pint-on');
      } else {
        btnWrapper.innerHTML = pintSVGEmpty();
      }
    }
  });

  // update overall 10
  const sum = Object.values(targetRatings).reduce((s,v)=>s+(v||0),0);
  const maxSum = CATEGORIES.length * MAX_PER_CAT;
  const scoreOutOf10 = Math.round((sum / maxSum) * 10); // 0..10 rounded
  overall10.innerHTML = '';
  for(let i=1;i<=10;i++){
    const el = document.createElement('div');
    el.className = 'overall-pint';
    el.innerHTML = (i <= scoreOutOf10) ? pintSVG() : pintSVGEmpty();
    if(i <= scoreOutOf10) el.firstElementChild.classList.add('overall-on');
    overall10.appendChild(el);
  }
}

/* -------------------------
   New Pint form handling
   ------------------------- */
const inputPubName = document.getElementById('input-pub-name');
const inputPhoto = document.getElementById('input-photo');
const photoPreview = document.getElementById('photo-preview');
const photoPreviewImg = document.getElementById('photo-preview-img');

let currentPhotoData = ''; // base64
inputPhoto.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    currentPhotoData = ev.target.result;
    photoPreviewImg.src = currentPhotoData;
    photoPreview.style.display = 'block';
  };
  reader.readAsDataURL(f);
});

function resetNewPintForm(){
  inputPubName.value = '';
  inputPhoto.value = '';
  currentPhotoData = '';
  photoPreviewImg.src = '';
  photoPreview.style.display = 'none';
  CATEGORIES.forEach(c=> currentRatings[c]=0);
  refreshRatingUI(currentRatings);
}

/* -------------------------
   Save New Pint
   ------------------------- */
function saveNewPint(){
  const name = inputPubName.value.trim();
  if(!name){ alert('Please enter a pub name'); return; }
  const sum = Object.values(currentRatings).reduce((s,v)=>s+(v||0),0);
  if(sum === 0){ if(!confirm('You have not rated any category. Save as unrated?')) return; }
  const maxSum = CATEGORIES.length * MAX_PER_CAT;
  const score10 = Math.round((sum / maxSum) * 10);
  const data = {
    id: 'p_'+Date.now(),
    pubName: name,
    photo: currentPhotoData || '',
    ratings: {...currentRatings},
    score10,
    created: Date.now()
  };
  const arr = loadPints();
  arr.unshift(data); // newest first
  savePints(arr);
  renderSavedPints();
  resetNewPintForm();
  alert('Pint saved locally!');
}

/* -------------------------
   Render saved pints (Map page)
   ------------------------- */
function renderSavedPints(){
  const list = document.getElementById('saved-pints-list');
  list.innerHTML = '';
  const arr = loadPints();
  if(arr.length === 0){
    list.innerHTML = '<div class="muted small">No pints saved yet. Add your first pint via "New".</div>';
    return;
  }
  arr.forEach(p=>{
    const el = document.createElement('div'); el.className='list-item';
    const thumb = document.createElement('div'); thumb.className='thumb';
    if(p.photo) thumb.innerHTML = `<img src="${p.photo}" alt="photo" />`;
    else thumb.innerHTML = `<div style="padding:6px;color:var(--muted);font-size:12px">No photo</div>`;
    const body = document.createElement('div'); body.className='item-body';
    const title = document.createElement('div'); title.innerHTML = `<strong>${escapeHtml(p.pubName)}</strong>`;
    const meta = document.createElement('div'); meta.className='small-muted';
    const d = new Date(p.created);
    meta.innerText = `${p.score10}/10 ‚Äî ${d.toLocaleString()}`;
    body.appendChild(title); body.appendChild(meta);

    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.gap='6px';
    const viewBtn = document.createElement('button'); viewBtn.className='btn ghost'; viewBtn.innerText='View';
    viewBtn.onclick = ()=> openPintViewer(p.id);
    const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.innerText='Delete';
    delBtn.onclick = ()=> {
      if(confirm('Delete this pint?')){
        const arr2 = loadPints().filter(x=>x.id!==p.id);
        savePints(arr2);
        renderSavedPints();
      }
    };
    right.appendChild(viewBtn); right.appendChild(delBtn);

    el.appendChild(thumb); el.appendChild(body); el.appendChild(right);
    list.appendChild(el);
  });
}

/* open viewer modal for a saved pint */
function openPintViewer(pintId){
  const arr = loadPints();
  const p = arr.find(x=>x.id===pintId);
  if(!p) return alert('Pint not found');
  const modal = createModal();
  modal.innerHTML = `
    <div class="modal">
      <h3>${escapeHtml(p.pubName)} ‚Äî ${p.score10}/10</h3>
      <div style="display:flex;gap:10px;margin-top:8px">
        <div style="width:140px;height:140px;border-radius:8px;overflow:hidden;background:#050505"><img src="${p.photo||''}" style="width:100%;height:100%;object-fit:cover" /></div>
        <div style="flex:1">
          <div class="muted small">Ratings:</div>
          <div style="margin-top:6px">
            ${CATEGORIES.map(c=>`<div style="margin:6px 0"><strong>${c}:</strong> ${p.ratings[c]||0}/5</div>`).join('')}
          </div>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" onclick="closeModal()">Close</button>
      </div>
    </div>
  `;
  document.getElementById('modal-root').appendChild(modal);
  modal.style.display='flex';
}

/* -------------------------
   Crawl: add Pub (uses same rating form inside modal)
   Each pub in crawl is standalone (you wanted no combined summary)
   ------------------------- */
function openCrawlAddPub(){
  const modal = createModal();
  const tmpRatings = {};
  CATEGORIES.forEach(c=>tmpRatings[c]=0);

  modal.innerHTML = `
    <div class="modal">
      <h3>Add Pub to Crawl</h3>
      <input id="modal-pub-name" class="input" placeholder="Pub name" />
      <label class="muted small" style="margin-top:6px">Photo (optional)</label>
      <input id="modal-photo" type="file" accept="image/*" class="input" style="padding:8px" />
      <div id="modal-photo-preview" style="margin-top:8px;display:none"><div class="thumb"><img id="modal-photo-preview-img" src="" /></div></div>
      <div id="modal-rating-area" style="margin-top:8px"></div>
      <div style="margin-top:8px">
        <div class="muted small">Overall (out of 10)</div>
        <div id="modal-overall" class="overall-row"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button class="btn ghost" onclick="closeModal()">Cancel</button>
        <button class="btn" id="modal-save-pub-btn">Add Pub</button>
      </div>
    </div>
  `;
  document.getElementById('modal-root').appendChild(modal);
  modal.style.display='flex';

  const modalRatingArea = modal.querySelector('#modal-rating-area');
  // build category UI inside modal
  CATEGORIES.forEach(cat=>{
    const wrapper = document.createElement('div');
    wrapper.style.marginTop = '8px';
    const label = document.createElement('div'); label.innerText = cat; label.className='small-muted';
    wrapper.appendChild(label);
    const row = document.createElement('div'); row.className='pint-row';
    for(let i=1;i<=MAX_PER_CAT;i++){
      const btn = document.createElement('button');
      btn.className='pint-btn';
      btn.innerHTML = pintSVGEmpty();
      btn.dataset.cat = cat;
      btn.dataset.value = i;
      btn.addEventListener('click', ()=> {
        tmpRatings[cat] = i;
        refreshModalRatingUI(modal,tmpRatings);
      });
      row.appendChild(btn);
    }
    wrapper.appendChild(row);
    modalRatingArea.appendChild(wrapper);
  });
  refreshModalRatingUI(modal,tmpRatings);

  // photo preview handler
  const modalPhotoInput = modal.querySelector('#modal-photo');
  const modalPhotoPreview = modal.querySelector('#modal-photo-preview');
  const modalPhotoPreviewImg = modal.querySelector('#modal-photo-preview-img');
  let modalPhotoData = '';
  modalPhotoInput.addEventListener('change', e=>{
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ev => {
      modalPhotoData = ev.target.result;
      modalPhotoPreviewImg.src = modalPhotoData;
      modalPhotoPreview.style.display = 'block';
    };
    r.readAsDataURL(f);
  });

  // save pub into crawl-list (UI)
  modal.querySelector('#modal-save-pub-btn').addEventListener('click', ()=>{
    const name = modal.querySelector('#modal-pub-name').value.trim();
    if(!name){ alert('Please enter pub name'); return; }
    const sum = Object.values(tmpRatings).reduce((s,v)=>s+(v||0),0);
    const maxSum = CATEGORIES.length * MAX_PER_CAT;
    const score10 = Math.round((sum / maxSum) * 10);
    const pubObj = {
      id: 'cpub_'+Date.now(),
      pubName: name,
      photo: modalPhotoData || '',
      ratings: {...tmpRatings},
      score10
    };
    addPubToCrawlUi(pubObj);
    closeModal();
  });
}

function refreshModalRatingUI(modal,tmpRatings){
  // update each pint button svg
  const rows = modal.querySelectorAll('.pint-row');
  rows.forEach((row, idx)=>{
    const cat = CATEGORIES[idx];
    const val = tmpRatings[cat] || 0;
    const btns = row.querySelectorAll('.pint-btn');
    btns.forEach((btn, i)=>{
      if(i < val) btn.innerHTML = pintSVG();
      else btn.innerHTML = pintSVGEmpty();
    });
  });
  // update modal overall
  const sum = Object.values(tmpRatings).reduce((s,v)=>s+(v||0),0);
  const maxSum = CATEGORIES.length * MAX_PER_CAT;
  const score10 = Math.round((sum/maxSum)*10);
  const overall = modal.querySelector('#modal-overall');
  overall.innerHTML = '';
  for(let i=1;i<=10;i++){
    const d = document.createElement('div');
    d.className = 'overall-pint';
    d.innerHTML = (i<=score10) ? pintSVG() : pintSVGEmpty();
    overall.appendChild(d);
  }
}

function addPubToCrawlUi(pubObj){
  const list = document.getElementById('crawl-pub-list');
  const el = document.createElement('div'); el.className='list-item';
  el.id = pubObj.id;
  const thumb = document.createElement('div'); thumb.className='thumb';
  if(pubObj.photo) thumb.innerHTML = `<img src="${pubObj.photo}" />`; else thumb.innerHTML = `<div style="padding:6px;color:var(--muted);font-size:12px">No photo</div>`;
  const body = document.createElement('div'); body.className='item-body';
  body.innerHTML = `<strong>${escapeHtml(pubObj.pubName)}</strong><div class="small-muted">${pubObj.score10}/10</div>`;
  const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.gap='6px';
  const viewBtn = document.createElement('button'); viewBtn.className='btn ghost'; viewBtn.innerText='View';
  viewBtn.onclick = ()=> openPubInCrawlViewer(pubObj);
  const removeBtn = document.createElement('button'); removeBtn.className='btn'; removeBtn.innerText='Remove';
  removeBtn.onclick = ()=> { if(confirm('Remove this pub from the crawl?')) el.remove(); };
  right.appendChild(viewBtn); right.appendChild(removeBtn);
  el.appendChild(thumb); el.appendChild(body); el.appendChild(right);
  list.appendChild(el);
}

/* Save Crawl (reads current form + pubs added in UI) */
function saveCrawl(){
  const name = document.getElementById('crawl-name').value.trim();
  if(!name){ alert('Please enter a crawl name'); return; }
  // participants
  const parts = [];
  for(let i=1;i<=5;i++){
    const v = document.getElementById('participant-'+i).value.trim();
    if(v) parts.push(v);
  }
  // pubs from UI
  const pubEls = Array.from(document.querySelectorAll('#crawl-pub-list .list-item'));
  if(pubEls.length === 0){ if(!confirm('No pubs added yet. Save empty crawl?')) return; }
  const pubs = pubEls.map(el=>{
    // rebuild pub object from DOM; we store data on element dataset if needed, but we'll capture minimal
    const id = el.id;
    const nameEl = el.querySelector('.item-body strong').innerText;
    const scoreText = el.querySelector('.item-body .small-muted').innerText || '0/10';
    const score = parseInt(scoreText.split('/')[0]) || 0;
    const img = el.querySelector('.thumb img') ? el.querySelector('.thumb img').src : '';
    return { id, pubName: nameEl, score10: score, photo: img };
  });
  const crawlObj = {
    id: 'crawl_'+Date.now(),
    name,
    participants: parts,
    pubs,
    created: Date.now()
  };
  const arr = loadCrawls();
  arr.unshift(crawlObj);
  saveCrawls(arr);
  renderSavedCrawls();
  clearCrawlForm();
  alert('Crawl saved locally!');
}

function clearCrawlForm(){
  document.getElementById('crawl-name').value = '';
  for(let i=1;i<=5;i++) document.getElementById('participant-'+i).value = '';
  document.getElementById('crawl-pub-list').innerHTML = '';
}

/* render saved crawls */
function renderSavedCrawls(){
  const container = document.getElementById('saved-crawls-list');
  container.innerHTML = '';
  const arr = loadCrawls();
  if(arr.length === 0){ container.innerHTML = '<div class="muted small">No saved crawls yet.</div>'; return; }
  arr.forEach(c=>{
    const el = document.createElement('div'); el.className='list-item';
    const thumb = document.createElement('div'); thumb.className='thumb'; thumb.innerHTML = `<div style="padding:6px;color:var(--muted);font-size:12px">Crawl</div>`;
    const body = document.createElement('div'); body.className='item-body';
    body.innerHTML = `<strong>${escapeHtml(c.name)}</strong><div class="small-muted">${(c.participants||[]).length} participants ‚Ä¢ ${c.pubs.length} pubs</div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.gap='6px';
    const view = document.createElement('button'); view.className='btn ghost'; view.innerText='View';
    view.onclick = ()=> openCrawlViewer(c.id);
    const del = document.createElement('button'); del.className='btn'; del.innerText='Delete';
    del.onclick = ()=> { if(confirm('Delete this crawl?')) { const arr2 = loadCrawls().filter(x=>x.id!==c.id); saveCrawls(arr2); renderSavedCrawls(); } };
    right.appendChild(view); right.appendChild(del);
    el.appendChild(thumb); el.appendChild(body); el.appendChild(right);
    container.appendChild(el);
  });
}

/* view a pub in crawl (modal) */
function openPubInCrawlViewer(pubObj){
  const modal = createModal();
  modal.innerHTML = `
    <div class="modal">
      <h3>${escapeHtml(pubObj.pubName)} ‚Äî ${pubObj.score10}/10</h3>
      <div style="display:flex;gap:10px;margin-top:8px">
        <div style="width:140px;height:140px;border-radius:8px;overflow:hidden;background:#050505"><img src="${pubObj.photo||''}" style="width:100%;height:100%;object-fit:cover" /></div>
        <div style="flex:1">
          <div class="muted small">Ratings:</div>
          <div style="margin-top:6px">
            ${CATEGORIES.map(c=>`<div style="margin:6px 0"><strong>${c}:</strong> ${pubObj.ratings && pubObj.ratings[c] ? pubObj.ratings[c] : '?'} /5</div>`).join('')}
          </div>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" onclick="closeModal()">Close</button>
      </div>
    </div>
  `;
  document.getElementById('modal-root').appendChild(modal);
  modal.style.display='flex';
}

/* view whole crawl */
function openCrawlViewer(crawlId){
  const arr = loadCrawls();
  const c = arr.find(x=>x.id===crawlId);
  if(!c) return alert('Crawl not found');
  const modal = createModal();
  modal.innerHTML = `
    <div class="modal">
      <h3>${escapeHtml(c.name)}</h3>
      <div class="muted small">Participants: ${ (c.participants||[]).join(', ') || 'none' }</div>
      <div style="margin-top:10px">
        ${ (c.pubs.length>0) ? c.pubs.map(p=>{
          return `<div style="display:flex;gap:12px;align-items:center;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-top:8px">
                    <div style="width:60px;height:60px;border-radius:8px;overflow:hidden;background:#050505"><img src="${p.photo||''}" style="width:100%;height:100%;object-fit:cover" /></div>
                    <div style="flex:1"><strong>${escapeHtml(p.pubName)}</strong><div class="small-muted">${p.score10}/10</div></div>
                    <div style="display:flex;flex-direction:column;gap:6px">
                      <button class="btn ghost" onclick="openPubInCrawlViewerFromModal('${crawlId}','${p.id}')">View</button>
                    </div>
                  </div>`;
        }).join('') : '<div class="muted small">No pubs in this crawl.</div>'}
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" onclick="closeModal()">Close</button>
      </div>
    </div>
  `;
  document.getElementById('modal-root').appendChild(modal);
  modal.style.display='flex';
}

/* open specific pub inside crawl from modal (reopens details) */
function openPubInCrawlViewerFromModal(crawlId,pubId){
  closeModal();
  const arr = loadCrawls();
  const c = arr.find(x=>x.id===crawlId);
  if(!c) return;
  const p = c.pubs.find(x=>x.id===pubId) || c.pubs.find(x=>x.id===pubId.replace('cpub_',''));
  if(!p) return alert('Pub not found');
  openPubInCrawlViewer(p);
}

/* -------------------------
   Profile handling
   ------------------------- */
function saveProfile(){
  const name = document.getElementById('profile-name').value.trim();
  const fav = document.getElementById('profile-fave').value.trim();
  saveProfileObj({ name, fav });
  renderProfileSummary();
  alert('Profile saved locally');
}
function clearProfile(){
  document.getElementById('profile-name').value='';
  document.getElementById('profile-fave').value='';
  saveProfileObj({});
  renderProfileSummary();
}
function renderProfileSummary(){
  const root = document.getElementById('profile-summary');
  const profile = loadProfile();
  const pints = loadPints();
  root.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:68px;height:68px;border-radius:12px;background:#050505;display:flex;align-items:center;justify-content:center"><div style="color:var(--muted)">You</div></div>
      <div>
        <div><strong>${profile.name||'‚Äî'}</strong></div>
        <div class="small-muted">${profile.fav || 'No favorite set'}</div>
      </div>
    </div>
    <div style="margin-top:12px" class="muted small">${pints.length} saved pints ‚Ä¢ ${loadCrawls().length} crawls</div>
  `;
}

/* -------------------------
   Navigation
   ------------------------- */
function showPage(pageId, btn){
  // hide all pages
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  // nav active
  document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active'));
  if(btn) btn.classList.add('active');
  // refresh view lists where needed
  if(pageId==='page-map') renderSavedPints();
  if(pageId==='page-crawl') { renderSavedCrawls(); }
  if(pageId==='page-profile') renderProfileSummary();
}
document.getElementById('nav-map').classList.add('active'); // default

/* -------------------------
   Modal utilities
   ------------------------- */
function createModal(){
  const root = document.getElementById('modal-root');
  const back = document.createElement('div'); back.className='modal-back';
  // clicking outside closes
  back.addEventListener('click', (e)=>{
    if(e.target === back) closeModal();
  });
  root.appendChild(back);
  return back;
}
function closeModal(){
  const root = document.getElementById('modal-root');
  root.innerHTML = '';
  root.style.display = 'none';
}

/* -------------------------
   Helpers
   ------------------------- */
function escapeHtml(unsafe) {
  return unsafe
       .replace(/&/g, "&amp;")
       .replace(/</g, "&lt;")
       .replace(/>/g, "&gt;")
       .replace(/"/g, "&quot;")
       .replace(/'/g, "&#039;");
}

/* -------------------------
   Init
   ------------------------- */
(function init(){
  // build New Pint rating UI
  buildRatingUI(currentRatings, (r)=>{ /* on change */ });
  // initial overall rendering
  refreshRatingUI(currentRatings);
  renderSavedPints();
  renderSavedCrawls();
  renderProfileSummary();
})();
</script>
</body>
</html>
