<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PintScore ‚Äî Guinness Rating</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#000;
  --panel:#0b0b0b;
  --muted:#9aa0a6;
  --gold:#d4af37;
  --card-border: rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Poppins",system-ui,Arial,sans-serif;
  background:linear-gradient(180deg,var(--bg),#050505 200px);
  color:#fff;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  display:flex;
  flex-direction:column;
  min-height:100vh;
}

/* App shell */
.app{flex:1 1 auto;display:flex;flex-direction:column;padding-bottom:78px}
header{padding:14px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);position:sticky;top:0;z-index:40}
.brand h1{font-size:18px;margin:0;font-weight:600}
.brand p{margin:0;font-size:12px;color:var(--muted)}
main{flex:1;padding:12px 16px;overflow:auto}

/* pages */
.page{display:none}
.page.active{display:block}

/* card */
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--card-border);padding:12px;border-radius:12px;margin-bottom:12px}

/* inputs */
.input{width:100%;padding:10px 12px;border-radius:8px;background:#0a0a0a;color:#fff;border:1px solid rgba(255,255,255,0.03);margin-top:8px;outline:none}
.small-muted{color:var(--muted);font-size:13px}
.row{display:flex;gap:8px;align-items:center}

/* pint icons */
.pint-row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.pint-btn{width:36px;height:46px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;background:transparent;border:none;padding:0;cursor:pointer}
.pint-svg{width:26px;height:40px}
.pint-empty .glass-fill{fill:#111}
.pint-empty .foam{fill:#cfc6ad;opacity:0.5}
.pint-on .glass-fill{fill:var(--gold)}
.pint-on .foam{fill:#fff2d1}

/* overall 10 */
.overall-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
.overall-pint{width:18px;height:26px;opacity:0.28}
.overall-on{opacity:1;filter:drop-shadow(0 4px 8px rgba(212,175,55,0.18))}

/* buttons */
.btn{display:inline-block;padding:10px 14px;border-radius:10px;border:none;background:var(--gold);color:#000;font-weight:700;cursor:pointer;margin-top:10px}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

/* lists */
.list-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px;background:rgba(255,255,255,0.01)}
.thumb{width:60px;height:60px;border-radius:8px;background:#050505;display:flex;align-items:center;justify-content:center;overflow:hidden}
.thumb img{width:100%;height:100%;object-fit:cover}
.item-body{flex:1}

/* bottom nav */
.bottom-nav{position:fixed;left:0;right:0;bottom:0;height:72px;background:linear-gradient(180deg,#060606,#040404);border-top:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-around;align-items:center;padding:6px 8px;z-index:60;backdrop-filter:blur(4px)}
.nav-btn{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);background:transparent;border:none;padding:6px;border-radius:10px;cursor:pointer;font-size:12px;width:64px}
.nav-btn.active{color:var(--gold)}
.nav-ico{font-size:20px}

/* modal */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:200}
.modal{width:94%;max-width:520px;background:linear-gradient(180deg,#0b0b0b,#090909);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.modal h3{margin:0 0 8px 0}

/* info tooltip */
.info-btn{margin-left:8px;color:var(--muted);cursor:pointer;font-size:14px}
.tooltip{position:fixed;background:#0b0b0b;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:8px;max-width:260px;color:#fff;z-index:300;box-shadow:0 8px 30px rgba(0,0,0,0.6)}

/* responsive */
@media(min-width:900px){main{max-width:880px;margin:0 auto}}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <svg width="40" height="40" viewBox="0 0 64 64" aria-hidden>
          <rect width="64" height="64" rx="10" fill="#0b0b0b"/>
          <g transform="translate(14,8) scale(.9)">
            <path d="M12 1c-3 0-5 3-5 6 0 5 4 9 7 9s7-4 7-9c0-3-2-6-5-6z" fill="#0f0f0f" stroke="#d4af37" stroke-width="1"/>
            <ellipse cx="12" cy="9" rx="6" ry="3" fill="#f3e6cf"/>
          </g>
        </svg>
        <div>
          <h1>PintScore</h1>
          <p class="small-muted">Rate your Guinness ‚Äî keep it simple</p>
        </div>
      </div>
    </header>

    <main>
      <!-- MAP PAGE -->
      <section id="page-map" class="page active">
        <div class="card">
          <h2>Saved Pints</h2>
          <p class="small-muted">All pints saved locally on this device.</p>
          <div id="saved-pints-list" style="margin-top:10px"></div>
          <div class="small-muted" style="margin-top:8px">Tip: Data is stored only on this device (Local Storage).</div>
        </div>
      </section>

      <!-- CRAWL PAGE -->
      <section id="page-crawl" class="page">
        <div class="card">
          <h2>Create Pub Crawl</h2>
          <input id="crawl-name" class="input" placeholder="Crawl name (e.g. Friday Crawl)" />
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <input class="input" id="participant-1" placeholder="Participant 1 (optional)"/>
            <input class="input" id="participant-2" placeholder="Participant 2 (optional)"/>
            <input class="input" id="participant-3" placeholder="Participant 3 (optional)"/>
            <input class="input" id="participant-4" placeholder="Participant 4 (optional)"/>
            <input class="input" id="participant-5" placeholder="Participant 5 (optional)"/>
          </div>

          <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
            <div class="small-muted">Pubs in this crawl</div>
            <div>
              <button class="btn" onclick="openCrawlAddPub()">+ Add Pub</button>
            </div>
          </div>
          <div id="crawl-pub-list" style="margin-top:10px"></div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" onclick="saveCrawl()">Save Crawl</button>
            <button class="btn ghost" onclick="clearCrawlForm()">Clear</button>
          </div>
        </div>

        <div class="card">
          <h3>Saved Crawls</h3>
          <div id="saved-crawls-list" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- NEW PINT PAGE -->
      <section id="page-new" class="page">
        <div class="card">
          <h2>New Pint</h2>
          <input id="input-pub-name" class="input" placeholder="Pub name" />
          <label class="small-muted" style="margin-top:6px">Upload photo (optional)</label>
          <input id="input-photo" type="file" accept="image/*" class="input" style="padding:8px" />
          <div id="photo-preview" style="margin-top:10px;display:none">
            <div style="width:100%;border-radius:10px;overflow:hidden;background:#050505" class="thumb"><img id="photo-preview-img" src="" alt="preview" /></div>
          </div>

          <div id="rating-categories" style="margin-top:10px"></div>

          <div style="margin-top:10px">
            <div class="small-muted">Overall (out of 10)</div>
            <div id="overall-10" class="overall-row"></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" onclick="saveNewPint()">Save Pint</button>
            <button class="btn ghost" onclick="resetNewPintForm()">Reset</button>
          </div>
        </div>
      </section>

      <!-- PROFILE PAGE -->
      <section id="page-profile" class="page">
        <div class="card">
          <h2>Profile</h2>
          <p class="small-muted">Local profile (stored in Local Storage)</p>
          <input id="profile-name" class="input" placeholder="Your name (optional)" />
          <input id="profile-fave" class="input" placeholder="Favorite pub / drink (optional)" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="saveProfile()">Save Profile</button>
            <button class="btn ghost" onclick="clearProfile()">Clear</button>
          </div>
        </div>

        <div class="card">
          <h3>Your Summary</h3>
          <div id="profile-summary" style="margin-top:10px"></div>
        </div>
      </section>
    </main>

    <!-- bottom nav -->
    <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
      <button class="nav-btn active" id="nav-map" onclick="showPage('page-map', this)"><div class="nav-ico">üó∫Ô∏è</div><div style="font-size:11px">Map</div></button>
      <button class="nav-btn" id="nav-crawl" onclick="showPage('page-crawl', this)"><div class="nav-ico">üë•</div><div style="font-size:11px">Crawl</div></button>
      <button class="nav-btn" id="nav-new" onclick="showPage('page-new', this)"><div class="nav-ico">‚ûï</div><div style="font-size:11px">New</div></button>
      <button class="nav-btn" id="nav-profile-btn" onclick="showPage('page-profile', this)"><div class="nav-ico">üßë</div><div style="font-size:11px">Profile</div></button>
    </nav>
  </div>

  <!-- modal root -->
  <div id="modal-root" style="display:none"></div>

<script>
/* ---------- Storage keys ---------- */
const STORE = { PINTS:'pintscore_pints_v1', CRAWLS:'pintscore_crawls_v1', PROFILE:'pintscore_profile_v1' };
const CATEGORIES = ['Creaminess','Head','Taste','Temperature','Atmosphere'];
const MAX_PER_CAT = 5;

/* ---------- helpers ---------- */
function load(key, def){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); }catch(e){ return def; } }
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
function uid(prefix='id'){ return prefix + '_' + Date.now() + '_' + Math.floor(Math.random()*9999); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

/* ---------- SVG pint (outline like provided) ---------- */
function pintOutlineSVG(active=false, width=26, height=40){
  // glass outline path simplified, with two shapes (body fill + foam)
  const fill = active ? '#d4af37' : '#111';
  const foam = active ? '#fff2d1' : '#cfc6ad';
  return `
  <svg class="pint-svg" viewBox="0 0 24 40" width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg" aria-hidden>
    <g>
      <!-- body -->
      <path class="glass-fill" d="M4 2h16c0 0-1 10-1 12 0 4-2 10-3 15-1 6-1 7-1 11 0 1-1 3-5 3s-5-2-5-3c0-4 0-5-1-11C6 24 4 18 4 14 3 12 4 2 4 2z" fill="${fill}" stroke="#000" stroke-opacity="0.12"/>
      <!-- foam -->
      <ellipse class="foam" cx="12" cy="8" rx="8" ry="4" fill="${foam}"/>
    </g>
  </svg>`;
}

/* ---------- Info texts ---------- */
const INFO_TEXTS = {
  'Creaminess': 'The perfect creaminess is smooth, velvety and stays consistent until the last sip.',
  'Head': 'A good head is dense, creamy and remains intact while you drink.',
  'Taste': 'Taste should be balanced with gentle roasted notes and no harsh bitterness.',
  'Temperature': 'Serve slightly cool, not ice cold ‚Äî roughly 6‚Äì8 ¬∞C for best flavour.',
  'Atmosphere': 'A proper pub atmosphere is warm, cozy and social ‚Äî it enhances the pint experience.'
};

/* ---------- Tooltip (info) ---------- */
let tooltipEl = null;
function showInfoAt(text, x, y){
  hideTooltip();
  tooltipEl = document.createElement('div');
  tooltipEl.className = 'tooltip';
  tooltipEl.innerText = text;
  document.body.appendChild(tooltipEl);
  // position
  const pad = 10;
  const rect = tooltipEl.getBoundingClientRect();
  let left = x - rect.width/2;
  if(left < 8) left = 8;
  if(left + rect.width > window.innerWidth - 8) left = window.innerWidth - rect.width - 8;
  let top = y - rect.height - 12;
  if(top < 8) top = y + 18;
  tooltipEl.style.left = left + 'px';
  tooltipEl.style.top = top + 'px';
}
function hideTooltip(){ if(tooltipEl){ tooltipEl.remove(); tooltipEl=null;} }

/* ---------- New Pint UI ---------- */
const ratingContainer = document.getElementById('rating-categories');
const overall10 = document.getElementById('overall-10');
const inputPubName = document.getElementById('input-pub-name');
const inputPhoto = document.getElementById('input-photo');
const photoPreview = document.getElementById('photo-preview');
const photoPreviewImg = document.getElementById('photo-preview-img');

let currentRatings = {}; CATEGORIES.forEach(c=>currentRatings[c]=0);
let currentPhotoData = '';

inputPhoto.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ev=>{
    currentPhotoData = ev.target.result;
    photoPreviewImg.src = currentPhotoData;
    photoPreview.style.display = 'block';
  };
  r.readAsDataURL(f);
});

function buildRatingUI(){
  ratingContainer.innerHTML = '';
  CATEGORIES.forEach(cat=>{
    const wrapper = document.createElement('div');
    wrapper.style.marginTop = '10px';
    const labelRow = document.createElement('div');
    labelRow.style.display='flex'; labelRow.style.alignItems='center';
    const label = document.createElement('div'); label.innerText = cat; label.className='small-muted';
    const infoBtn = document.createElement('div'); infoBtn.innerHTML='‚ìò'; infoBtn.className='info-btn';
    infoBtn.title = 'Info';
    infoBtn.addEventListener('click', (ev)=>{
      const rect = ev.currentTarget.getBoundingClientRect();
      showInfoAt(INFO_TEXTS[cat], rect.left + rect.width/2, rect.top);
    });
    labelRow.appendChild(label); labelRow.appendChild(infoBtn);
    wrapper.appendChild(labelRow);

    const row = document.createElement('div'); row.className='pint-row';
    for(let i=1;i<=MAX_PER_CAT;i++){
      const btn = document.createElement('button'); btn.className='pint-btn pint-empty';
      btn.innerHTML = pintOutlineSVG(false);
      btn.dataset.cat = cat; btn.dataset.value = i;
      btn.addEventListener('click', ()=>{
        currentRatings[cat] = i;
        refreshRatingUI();
      });
      row.appendChild(btn);
    }
    wrapper.appendChild(row);
    ratingContainer.appendChild(wrapper);
  });
  refreshRatingUI();
}

function refreshRatingUI(){
  // categories
  const rows = ratingContainer.querySelectorAll('.pint-row');
  rows.forEach((row, idx)=>{
    const cat = CATEGORIES[idx];
    const val = currentRatings[cat] || 0;
    const btns = row.querySelectorAll('.pint-btn');
    btns.forEach((b, i)=>{
      b.innerHTML = (i < val) ? pintOutlineSVG(true) : pintOutlineSVG(false);
      b.classList.toggle('pint-on', i < val);
    });
  });
  // overall
  const sum = Object.values(currentRatings).reduce((s,v)=>s+(v||0),0);
  const maxSum = CATEGORIES.length * MAX_PER_CAT;
  const score10 = Math.round((sum / maxSum) * 10);
  overall10.innerHTML = '';
  for(let i=1;i<=10;i++){
    const d = document.createElement('div');
    d.className = 'overall-pint';
    d.innerHTML = (i <= score10) ? pintOutlineSVG(true,16,26) : pintOutlineSVG(false,16,26);
    overall10.appendChild(d);
  }
}

/* reset / save new pint */
function resetNewPintForm(){
  inputPubName.value=''; inputPhoto.value=''; currentPhotoData=''; photoPreviewImg.src=''; photoPreview.style.display='none';
  CATEGORIES.forEach(c=>currentRatings[c]=0); refreshRatingUI();
}
function saveNewPint(){
  const name = inputPubName.value.trim();
  if(!name){ alert('Enter pub name'); return; }
  const sum = Object.values(currentRatings).reduce((s,v)=>s+(v||0),0);
  if(sum === 0 && !confirm('No ratings set. Save as unrated?')) return;
  const maxSum = CATEGORIES.length * MAX_PER_CAT;
  const score10 = Math.round((sum / maxSum) * 10);
  const p = { id: uid('p'), pubName: name, photo: currentPhotoData || '', ratings: {...currentRatings}, score10, created: Date.now() };
  const arr = load(STORE.PINTS, []);
  arr.unshift(p);
  save(STORE.PINTS, arr);
  renderSavedPints();
  resetNewPintForm();
  alert('Pint saved locally!');
}

/* render saved pints list */
function renderSavedPints(){
  const el = document.getElementById('saved-pints-list');
  const arr = load(STORE.PINTS, []);
  el.innerHTML = '';
  if(arr.length === 0){ el.innerHTML = '<div class="small-muted">No pints yet. Add one via New.</div>'; return; }
  arr.forEach(p=>{
    const item = document.createElement('div'); item.className='list-item';
    const thumb = document.createElement('div'); thumb.className='thumb';
    if(p.photo) thumb.innerHTML = `<img src="${p.photo}">`; else thumb.innerHTML = `<div style="padding:6px;color:var(--muted);font-size:12px">No photo</div>`;
    const body = document.createElement('div'); body.className='item-body';
    body.innerHTML = `<strong>${escapeHtml(p.pubName)}</strong><div class="small-muted">${p.score10}/10 ‚Ä¢ ${new Date(p.created).toLocaleString()}</div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.gap='6px';
    const view = document.createElement('button'); view.className='btn ghost'; view.innerText='View'; view.onclick = ()=> openPintViewer(p.id);
    const del = document.createElement('button'); del.className='btn'; del.innerText='Delete'; del.onclick = ()=> { if(confirm('Delete?')){ const newArr = load(STORE.PINTS,[]).filter(x=>x.id!==p.id); save(STORE.PINTS,newArr); renderSavedPints(); } };
    right.appendChild(view); right.appendChild(del);
    item.appendChild(thumb); item.appendChild(body); item.appendChild(right);
    el.appendChild(item);
  });
}

/* viewer */
function openPintViewer(id){
  const arr = load(STORE.PINTS, []);
  const p = arr.find(x=>x.id===id); if(!p) return alert('Not found');
  const modal = createModal();
  modal.innerHTML = `<div class="modal">
    <h3>${escapeHtml(p.pubName)} ‚Äî ${p.score10}/10</h3>
    <div style="display:flex;gap:12px;margin-top:8px">
      <div style="width:140px;height:140px;border-radius:8px;overflow:hidden;background:#050505"><img src="${p.photo||''}" style="width:100%;height:100%;object-fit:cover" /></div>
      <div style="flex:1">
        <div class="small-muted">Ratings:</div>
        <div style="margin-top:8px">${CATEGORIES.map(c=>`<div style="margin:6px 0"><strong>${c}:</strong> ${p.ratings[c]||0}/5</div>`).join('')}</div>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button class="btn ghost" onclick="closeModal()">Close</button></div>
  </div>`;
  document.getElementById('modal-root').appendChild(modal); modal.style.display='flex';
}

/* ---------- Crawl: add pub modal (same rating UI but per-pub) ---------- */
function openCrawlAddPub(){
  const modal = createModal();
  // temp ratings for this modal
  const tmp = {}; CATEGORIES.forEach(c=>tmp[c]=0);
  let modalPhotoData = '';
  modal.innerHTML = `<div class="modal">
    <h3>Add Pub to Crawl</h3>
    <input id="modal-pub-name" class="input" placeholder="Pub name" />
    <label class="small-muted" style="margin-top:6px">Photo (optional)</label>
    <input id="modal-photo" type="file" accept="image/*" class="input" style="padding:8px" />
    <div id="modal-photo-preview" style="margin-top:8px;display:none"><div class="thumb"><img id="modal-photo-preview-img" src=""></div></div>
    <div id="modal-rating-area" style="margin-top:8px"></div>
    <div style="margin-top:8px"><div class="small-muted">Overall (out of 10)</div><div id="modal-overall" class="overall-row"></div></div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end"><button class="btn ghost" onclick="closeModal()">Cancel</button><button class="btn" id="modal-add-btn">Add Pub</button></div>
  </div>`;
  document.getElementById('modal-root').appendChild(modal); modal.style.display='flex';

  // build rating area inside modal
  const modalRatingArea = modal.querySelector('#modal-rating-area');
  CATEGORIES.forEach(cat=>{
    const wrap = document.createElement('div'); wrap.style.marginTop='8px';
    const labelRow = document.createElement('div'); labelRow.style.display='flex'; labelRow.style.alignItems='center';
    const lbl = document.createElement('div'); lbl.innerText = cat; lbl.className='small-muted';
    const inf = document.createElement('div'); inf.innerHTML='‚ìò'; inf.className='info-btn';
    inf.addEventListener('click', (ev)=>{ const r = ev.currentTarget.getBoundingClientRect(); showInfoAt(INFO_TEXTS[cat], r.left + r.width/2, r.top); });
    labelRow.appendChild(lbl); labelRow.appendChild(inf); wrap.appendChild(labelRow);

    const row = document.createElement('div'); row.className='pint-row';
    for(let i=1;i<=MAX_PER_CAT;i++){
      const btn = document.createElement('button'); btn.className='pint-btn';
      btn.innerHTML = pintOutlineSVG(false);
      btn.dataset.cat = cat; btn.dataset.value = i;
      btn.addEventListener('click', ()=>{
        tmp[cat] = i; refreshModalRatingUI(modal,tmp);
      });
      row.appendChild(btn);
    }
    wrap.appendChild(row); modalRatingArea.appendChild(wrap);
  });
  refreshModalRatingUI(modal,tmp);

  // photo preview
  const photoInput = modal.querySelector('#modal-photo'), photoPrev = modal.querySelector('#modal-photo-preview'), photoPrevImg = modal.querySelector('#modal-photo-preview-img');
  photoInput.addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader(); r.onload = ev=>{ modalPhotoData = ev.target.result; photoPrevImg.src = modalPhotoData; photoPrev.style.display = 'block'; }; r.readAsDataURL(f);
  });

  // add button
  modal.querySelector('#modal-add-btn').addEventListener('click', ()=>{
    const name = modal.querySelector('#modal-pub-name').value.trim(); if(!name){ alert('Enter pub name'); return; }
    const sum = Object.values(tmp).reduce((s,v)=>s+(v||0),0); const max = CATEGORIES.length*MAX_PER_CAT; const score10 = Math.round((sum/max)*10);
    const pubObj = { id: uid('cpub'), pubName: name, photo: modalPhotoData||'', ratings: {...tmp}, score10 };
    // append UI element to crawl list
    addPubToCrawlUi(pubObj);
    closeModal();
  });
}

function refreshModalRatingUI(modal,tmp){
  const rows = modal.querySelectorAll('.pint-row');
  rows.forEach((row, idx)=>{
    const cat = CATEGORIES[idx]; const val = tmp[cat]||0;
    const btns = row.querySelectorAll('.pint-btn');
    btns.forEach((b,i)=> b.innerHTML = (i<val) ? pintOutlineSVG(true) : pintOutlineSVG(false));
  });
  const sum = Object.values(tmp).reduce((s,v)=>s+(v||0),0); const max = CATEGORIES.length*MAX_PER_CAT; const score10 = Math.round((sum/max)*10);
  const overall = modal.querySelector('#modal-overall'); overall.innerHTML='';
  for(let i=1;i<=10;i++){ const d=document.createElement('div'); d.className='overall-pint'; d.innerHTML = (i<=score10)?pintOutlineSVG(true,16,26):pintOutlineSVG(false,16,26); overall.appendChild(d); }
}

function addPubToCrawlUi(pubObj){
  const list = document.getElementById('crawl-pub-list');
  const el = document.createElement('div'); el.className='list-item'; el.id = pubObj.id;
  const thumb = document.createElement('div'); thumb.className='thumb'; thumb.innerHTML = pubObj.photo?`<img src="${pubObj.photo}">`:`<div style="padding:6px;color:var(--muted);font-size:12px">No photo</div>`;
  const body = document.createElement('div'); body.className='item-body'; body.innerHTML = `<strong>${escapeHtml(pubObj.pubName)}</strong><div class="small-muted">${pubObj.score10}/10</div>`;
  const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.gap='6px';
  const view = document.createElement('button'); view.className='btn ghost'; view.innerText='View'; view.onclick = ()=> openPubInCrawlViewer(pubObj);
  const remove = document.createElement('button'); remove.className='btn'; remove.innerText='Remove'; remove.onclick = ()=> { if(confirm('Remove this pub?')) el.remove(); };
  right.appendChild(view); right.appendChild(remove);
  el.appendChild(thumb); el.appendChild(body); el.appendChild(right);
  list.appendChild(el);
}

/* save crawl */
function saveCrawl(){
  const name = document.getElementById('crawl-name').value.trim(); if(!name){ alert('Enter crawl name'); return; }
  const participants = []; for(let i=1;i<=5;i++){ const v=document.getElementById('participant-'+i).value.trim(); if(v) participants.push(v); }
  const pubEls = Array.from(document.querySelectorAll('#crawl-pub-list .list-item'));
  if(pubEls.length===0 && !confirm('No pubs added. Save empty crawl?')) return;
  const pubs = pubEls.map(el=>{
    const title = el.querySelector('.item-body strong').innerText;
    const scoreText = el.querySelector('.item-body .small-muted').innerText || '0/10'; const score = parseInt(scoreText.split('/')[0])||0;
    const img = el.querySelector('.thumb img')? el.querySelector('.thumb img').src : '';
    return { id: el.id, pubName: title, score10: score, photo: img };
  });
  const obj = { id: uid('crawl'), name, participants, pubs, created: Date.now() };
  const arr = load(STORE.CRAWLS, []); arr.unshift(obj); save(STORE.CRAWLS, arr);
  renderSavedCrawls(); clearCrawlForm(); alert('Crawl saved locally!');
}

function clearCrawlForm(){ document.getElementById('crawl-name').value=''; for(let i=1;i<=5;i++) document.getElementById('participant-'+i).value=''; document.getElementById('crawl-pub-list').innerHTML=''; }

/* render crawls */
function renderSavedCrawls(){
  const root = document.getElementById('saved-crawls-list'); root.innerHTML='';
  const arr = load(STORE.CRAWLS, []);
  if(arr.length===0){ root.innerHTML = '<div class="small-muted">No crawls yet.</div>'; return; }
  arr.forEach(c=>{
    const el = document.createElement('div'); el.className='list-item';
    const thumb = document.createElement('div'); thumb.className='thumb'; thumb.innerHTML = `<div style="padding:6px;color:var(--muted);font-size:12px">Crawl</div>`;
    const body = document.createElement('div'); body.className='item-body'; body.innerHTML = `<strong>${escapeHtml(c.name)}</strong><div class="small-muted">${(c.participants||[]).length} participants ‚Ä¢ ${c.pubs.length} pubs</div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.gap='6px';
    const view = document.createElement('button'); view.className='btn ghost'; view.innerText='View'; view.onclick = ()=> openCrawlViewer(c.id);
    const del = document.createElement('button'); del.className='btn'; del.innerText='Delete'; del.onclick = ()=> { if(confirm('Delete crawl?')){ const arr2 = load(STORE.CRAWLS,[]).filter(x=>x.id!==c.id); save(STORE.CRAWLS,arr2); renderSavedCrawls(); } };
    right.appendChild(view); right.appendChild(del);
    el.appendChild(thumb); el.appendChild(body); el.appendChild(right);
    root.appendChild(el);
  });
}

/* view pub inside crawl */
function openPubInCrawlViewer(pub){
  const modal = createModal();
  modal.innerHTML = `<div class="modal">
    <h3>${escapeHtml(pub.pubName)} ‚Äî ${pub.score10}/10</h3>
    <div style="display:flex;gap:12px;margin-top:8px">
      <div style="width:140px;height:140px;border-radius:8px;overflow:hidden;background:#050505"><img src="${pub.photo||''}" style="width:100%;height:100%;object-fit:cover" /></div>
      <div style="flex:1">
        <div class="small-muted">Ratings:</div>
        <div style="margin-top:8px">${CATEGORIES.map(c=>`<div style="margin:6px 0"><strong>${c}:</strong> ${pub.ratings && pub.ratings[c] ? pub.ratings[c] : '?'} /5</div>`).join('')}</div>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button class="btn ghost" onclick="closeModal()">Close</button></div>
  </div>`;
  document.getElementById('modal-root').appendChild(modal); modal.style.display='flex';
}

/* ---------- Profile ---------- */
function saveProfile(){ const name=document.getElementById('profile-name').value.trim(); const fav=document.getElementById('profile-fave').value.trim(); save(STORE.PROFILE,{name,fav}); renderProfileSummary(); alert('Profile saved'); }
function clearProfile(){ document.getElementById('profile-name').value=''; document.getElementById('profile-fave').value=''; save(STORE.PROFILE,{}); renderProfileSummary(); }
function renderProfileSummary(){ const root=document.getElementById('profile-summary'); const p=load(STORE.PROFILE,{}); const pints=load(STORE.PINTS,[]); root.innerHTML=`<div style="display:flex;gap:12px;align-items:center"><div style="width:68px;height:68px;border-radius:12px;background:#050505;display:flex;align-items:center;justify-content:center"><div style="color:var(--muted)">You</div></div><div><div><strong>${escapeHtml(p.name)||'‚Äî'}</strong></div><div class="small-muted">${escapeHtml(p.fav)||'No favorite set'}</div></div></div><div style="margin-top:12px" class="small-muted">${pints.length} saved pints ‚Ä¢ ${load(STORE.CRAWLS,[]).length} crawls</div>`; }

/* ---------- Navigation ---------- */
function showPage(id, btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active'));
  if(btn) btn.classList.add('active');
  hideTooltip();
  if(id==='page-map') renderSavedPints();
  if(id==='page-crawl') renderSavedCrawls();
  if(id==='page-profile') renderProfileSummary();
}

/* ---------- Modal helpers ---------- */
function createModal(){ const root=document.getElementById('modal-root'); const back=document.createElement('div'); back.className='modal-back'; back.addEventListener('click', (e)=>{ if(e.target===back) closeModal(); }); root.appendChild(back); root.style.display='block'; return back; }
function closeModal(){ const root=document.getElementById('modal-root'); root.innerHTML=''; root.style.display='none'; hideTooltip(); }

/* ---------- init ---------- */
(function init(){
  buildRatingUI();
  refreshRatingUI();
  renderSavedPints();
  renderSavedCrawls();
  renderProfileSummary();
  // default page active nav
  document.getElementById('nav-map').classList.add('active');
  // hide tooltip on scroll/click outside
  document.addEventListener('click', (e)=>{ if(!e.target.classList.contains('info-btn')) hideTooltip(); });
})();

</script>
</body>
</html>
